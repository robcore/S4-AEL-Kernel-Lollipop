From 1b787b00326d13c58e94e3e02a0fd1779b18536f Mon Sep 17 00:00:00 2001
From: shminer <332574643@qq.com>
Date: Tue, 21 Apr 2015 04:28:09 +0800
Subject: [PATCH] drop: thermal: msm: Remove early init from board file

---
 arch/arm/mach-msm/lge/board-8084-t6-kr.c |  4 ----
 drivers/thermal/intelli/msm_thermal.c    | 13 ++++++++++++-
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-msm/lge/board-8084-t6-kr.c b/arch/arm/mach-msm/lge/board-8084-t6-kr.c
index 6ff7b1d..93f9344 100644
--- a/arch/arm/mach-msm/lge/board-8084-t6-kr.c
+++ b/arch/arm/mach-msm/lge/board-8084-t6-kr.c
@@ -21,8 +21,6 @@
 #ifdef CONFIG_LGE_PM
 #include <linux/regulator/machine.h>
 #endif
-#include <linux/msm_tsens.h>
-#include <linux/msm_thermal.h>
 #include <linux/clk/msm-clk-provider.h>
 #include <asm/mach/map.h>
 #include <asm/mach/arch.h>
@@ -94,8 +92,6 @@ void __init apq8084_add_drivers(void)
 		msm_clock_init(&apq8084_rumi_clock_init_data);
 	else
 		msm_clock_init(&apq8084_clock_init_data);
-	tsens_tm_init_driver();
-	msm_thermal_device_init();
 #ifdef CONFIG_LGE_LCD_TUNING
 	lge_add_lcd_misc_devices();
 #endif
diff --git a/drivers/thermal/intelli/msm_thermal.c b/drivers/thermal/intelli/msm_thermal.c
index 536e1a4..10fb044 100644
--- a/drivers/thermal/intelli/msm_thermal.c
+++ b/drivers/thermal/intelli/msm_thermal.c
@@ -2537,7 +2537,17 @@ int msm_thermal_pre_init(void)
 {
 	int ret = 0;
 
-	tsens_get_max_sensor_num(&max_tsens_num);
+	if (tsens_is_ready() <= 0) {
+		pr_err("Tsens driver is not ready yet\n");
+		return -EPROBE_DEFER;
+	}
+
+	ret = tsens_get_max_sensor_num(&max_tsens_num);
+	if (ret < 0) {
+		pr_err("failed to get max sensor number, err:%d\n", ret);
+		return ret;
+	}
+
 	if (create_sensor_id_map()) {
 		pr_err("Creating sensor id map failed\n");
 		ret = -EINVAL;
@@ -3500,6 +3510,7 @@ int __init msm_thermal_device_init(void)
 {
 	return platform_driver_register(&msm_thermal_device_driver);
 }
+arch_initcall(msm_thermal_device_init);
 
 int __init msm_thermal_late_init(void)
 {
