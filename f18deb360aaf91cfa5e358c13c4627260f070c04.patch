From f18deb360aaf91cfa5e358c13c4627260f070c04 Mon Sep 17 00:00:00 2001
From: Linux Build Service Account <lnxbuild@localhost>
Date: Sat, 13 Dec 2014 09:16:55 -0800
Subject: [PATCH] Merge " SoC: msm: Add Buffer overflow check"

---
 arch/arm/mach-msm/qdsp6v2/audio_utils.c | 11 ++++++++++-
 sound/soc/msm/qdsp6/q6asm.c             |  4 ++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-msm/qdsp6v2/audio_utils.c b/arch/arm/mach-msm/qdsp6v2/audio_utils.c
index f99fcd6..eef63ae 100644
--- a/arch/arm/mach-msm/qdsp6v2/audio_utils.c
+++ b/arch/arm/mach-msm/qdsp6v2/audio_utils.c
@@ -23,7 +23,11 @@
 #include <asm/ioctls.h>
 #include "audio_utils.h"
 
-#define FRAME_SIZE            (1 + ((1536+sizeof(struct meta_out_dsp)) * 5))
+#define MIN_FRAME_SIZE  1536
+#define NUM_FRAMES     5
+#define META_SIZE      (sizeof(struct meta_out_dsp))
+#define FRAME_SIZE     (1 + ((MIN_FRAME_SIZE + META_SIZE) * NUM_FRAMES))
+
 static int audio_in_pause(struct q6audio_in  *audio)
 {
 	int rc;
@@ -259,6 +263,11 @@ long audio_in_ioctl(struct file *file,
 			rc = -EINVAL;
 			break;
 		}
+		if ((cfg.buffer_size > FRAME_SIZE) ||
+			(cfg.buffer_count != FRAME_NUM)) {
+			rc = -EINVAL;
+			break;
+		}
 		if (cfg.buffer_size > FRAME_SIZE) {
 			rc = -EINVAL;
 			break;
diff --git a/sound/soc/msm/qdsp6/q6asm.c b/sound/soc/msm/qdsp6/q6asm.c
index 6f8c64d..8b1a2c4 100644
--- a/sound/soc/msm/qdsp6/q6asm.c
+++ b/sound/soc/msm/qdsp6/q6asm.c
@@ -57,6 +57,7 @@
 #define OUT_BUFFER_SIZE 56
 #define IN_BUFFER_SIZE 24
 #endif
+#define FRAME_NUM   (8)
 static DEFINE_MUTEX(session_lock);
 extern int32_t ep_data;
 /* session id: 0 reserved */
@@ -507,6 +508,9 @@ int q6asm_audio_client_buf_alloc(unsigned int dir,
 			pr_debug("%s: buffer already allocated\n", __func__);
 			return 0;
 		}
+
+		if (bufcnt != FRAME_NUM)
+			goto fail;
 		mutex_lock(&ac->cmd_lock);
 		buf = kzalloc(((sizeof(struct audio_buffer))*bufcnt),
 				GFP_KERNEL);
